<html>
<head>
	<meta charset="utf-8">

	<title>K-means Text Clustering</title>
	<meta name="description" content="text clustering UI">
	<meta name="author" content="wendy">
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.min.js"></script>
	<!--  <meta http-equiv="cache-control" content="no-cache, must-revalidate, post-check=0, pre-check=0" />
	 <meta http-equiv="cache-control" content="max-age=0" />
	 <meta http-equiv="expires" content="0" />
	 <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
	 <meta http-equiv="pragma" content="no-cache" /> -->
	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
	<meta http-equiv="Pragma" content="no-cache" />
	<meta http-equiv="Expires" content="0" />
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.2/css/bootstrap.min.css" integrity="sha384-Smlep5jCw/wG7hdkwQ/Z5nLIefveQRIY9nfy6xoR1uRYBtpZgI6339F5dgvm/e9B" crossorigin="anonymous">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<script>
		function markValid(boxId) {
		    var box = document.getElementById( boxId );
		    var clusterId = boxId.substring(0, boxId.indexOf('VerifyBox'));
		    console.log(clusterId);
		    var titleId = clusterId + 'Title';
		    if ( box.checked ) {
		        document.getElementById(titleId).style.color = "#228B22";
		        $('#form').append("<input type='hidden' id=\"" + clusterId + "data\" name=\"" + clusterId + "\" value=\"" + document.getElementById(clusterId+'VerifyBox').value + "\">")
		        var goodDocs = document.getElementById(clusterId).getElementsByClassName('goodDoc');
		        for(var i = 0; i < goodDocs.length; i++){
		        	goodDocs[i].style.display = "none";
		        }

		    }
		    else{
		    	document.getElementById(titleId).style.color = "#000000";
		    	$('#' + clusterId + 'data').remove();
		    	var goodDocs = document.getElementById(clusterId).getElementsByClassName('goodDoc');
		        for(var i = 0; i < goodDocs.length; i++){
		        	goodDocs[i].style.display = "block";
		        }
		    }

		}

		function markDocument(sentenceId){
			var element = document.getElementById(sentenceId);
    		element.classList.toggle("goodDoc");
    		element.classList.toggle("badDoc");
    		var clusterId = sentenceId.substring(0, sentenceId.indexOf("sentence"));
    		document.getElementById(clusterId + 'VerifyBox').value = getVerifiedClusterData(clusterId);
		}

		function getVerifiedClusterData(clusterId){
			var str = "";
			var cluster = document.getElementById(clusterId);
			var rightSide = cluster.getElementsByClassName('col-md-3')[0];
			var clusterTitle = document.getElementById(clusterId + "Title").innerHTML.trim();
			var topWords = rightSide.getElementsByClassName('topWord');
			var docs = cluster.getElementsByClassName('docBody')[0];
			var goodDocs = docs.getElementsByClassName('goodDoc');

			str += clusterTitle + "\n";
			for(var i = 0; i < topWords.length; i++){
				str += topWords[i].innerHTML.trim() + "\n";
			}

			for(var i=0; i<goodDocs.length; i++)
            {
                str += goodDocs[i].textContent.trim().substring(4, goodDocs[i].textContent.lastIndexOf('\"')) + goodDocs[i].textContent.trim().substring(goodDocs[i].textContent.lastIndexOf('\"') + 1) + "\n";

                // str += goodDocs[i].innerHTML.substring(goodDocs[i].innerHTML.indexOf('>')+1).substring(goodDocs[i].innerHTML.indexOf("'")+1) + "\n";
            }

            return str.replace(/"/g, "'");
		}

		function aggregateBadDocs(btnId){
			var badData = "";
			$(".docBody div:visible").each(function() { 
			    console.log($(this).attr('id')); 
			    badData += this.textContent.trim().substring(4, this.textContent.lastIndexOf('" (')) + "\n";
			});

			document.getElementById(btnId).value = badData;
		}

		function showHowTo(){
			alert("Click on individual sentences in each cluster to mark them as irrelevant. After pruning, mark cluster as valid with the 'Verify' checkbox. \n\nClick 'See Verified Clusters' button to go to page of valid clusters. \n\n'Recalculate Invalid Documents' to run k-means algorithm on the leftover off-topic sentences");
		}
	</script>
	<style>
	#backCover{
		position: fixed;
		background: rgba(255,255,255, 1);
		width: 100%;
		z-index: 500;
		left: 0px;
	}
	.badDoc{
		color: rgba(254, 27, 7, 0.7);
		margin-bottom: 20;
	}
	button{
		margin: 10;
		float: right;
	}
	.clusterData{
	    border-bottom: 1px solid black;
	    padding: 10 10;
	}
	#clusterSummaries{
		border-bottom: 1px solid black;
		padding: 10 10;
	}
	.clusterTitle{
	    font-size: 1.5rem;
	    font-weight: bold;
	    margin-bottom: 5;
	}
	.docBody{
		overflow-y: scroll;
		height: 200px;"
	}
	.docCount{
		float: left;
		width: 75%;
	}
	.fa-question-circle {
		cursor: pointer;
	}
	.goodDoc{
		color: black;
	    margin-bottom: 20;
	}
	.goodDoc, .badDoc{
		cursor: pointer;
	}
	h3{
		display: inline-block;
	}
	#header{
		position: fixed;
		display: block;
		background: rgba(255,255,255, 1);
		z-index: 999;
	}
	.summary{
		float: left;
		text-align: center;
	}
	.summary mark{
		background-color: rgba(37,101,222,0.6) !important;
	}
	#topRow{
		padding-top: 10;
	}
	#totalDocCount{
		font-size: 1.25rem;
		margin-bottom: 10;
	}
/*	.verify{
		float: right;
	}*/
	.wordHeader, .docHeader{
		font-size: 1.25rem;
	    margin-bottom: 10;
	}
	/*
	input[type='checkbox']{
		padding-bottom: : 0.5rem;
	}*/
	</style>
</head>

<body>
	<!-- <script src="coms_cluster_data.js"></script> -->
	<!-- <script src='coms_cluster_data.js'></script>  -->
	<script>
		$(document).ready(function(){
			var d = JSON.parse(JSON.stringify('{{ clusters | tojson }}'));
			var data = jQuery.parseJSON( d );

			var warning = '{{ alert }}';
			if(warning){
				alert(warning);
			}

			var c = '{{ count }}'
			var row = "<div id='header'> \
						<div class='row' id='topRow'> \
							<div class='col-md-6'> \
								<div id='totalDocCount'> \
									<h3> K-Means Text Clustering </h3> \
									<i class='fa fa-question-circle' onclick='showHowTo()'></i> <br>\
								</div> \
							</div> \
							<div class='col-md-6'> \
								<form action='{{ url_for('verified') }}' method='post' id='form' target='_blank'>\
									<button name='verifyBtn' id='verifyBtn' type='submit'> \
										See Verified Clusters \
									</button> \
								</form>\
							</div>\
						</div> \
						<div class='row'> \
							<div class='col-md-12'> \
								<form action='{{ url_for('recluster', counter=count) }}' method='post' id='form' name='stopwordInput'>\
									Add Stop Word: \
									<input type='text' name='addStopword'> \
									Remove Stop Word: \
									<input type='text' name='removeStopword'> \
									K: \
									<input type='text' name='k'> \
									N Top Words: \
									<input type='text' name='nTopWords'> \
									<br> \
									<button name='reclusterBadBtn' id='reclusterBadBtn' type='submit' onclick='aggregateBadDocs(this.id)'' value=''> \
										Recalculate Invalid Documents \
									</button> \
									<button name='reclusterBtn' type='submit' value='recalcDiffSeed'> \
										Recalculate with New Seed \
									</button> \
									<button name='reclusterBtn' type='submit' value='recalcSameSeed'> \
										Recalculate \
									</button> \
								</form>\
								<br> \
							</div> \
						</div> \
						<div class='row'> \
							<div class='col-md-12' id='stopWordsRow'> \
							</div> \
						</div> \
						<div class='row'> \
							<div class='col-md-12' id='clusterSummaries'> \
								<div> \
									Overview: \
								</div> \
							</div> \
						</div> \
						</div> \
						<div id='backCover'> \
						</div> \
						<div id='filler'> \
						</div>";
			$(".container").append(row);
			// Append 'summaries' of clusters to header
			// var numClusters = 0;
			// for(d in data){
			// 	var id = d.replace(/\s+/g, '-');
			// 	$("#clusterSummaries").append("<div class='summary'><a href='#" + id + "'>" + d + "</a><br><b>" + data[d][0]["word"] + "</b> <div id='" + id + "summaryDocCount'></div>" + "</div>");
			// 	numClusters = numClusters + 1;
			// }
			// var screenPercent = 100/numClusters + "%";
			// $('.summary').css('width', screenPercent);

			console.log(data);
			var numClusters = 0;
			for(d in data){
				if(d === "Document count"){
					$('#totalDocCount').append('Total Document Count: ' + data[d]);
				}
				else{
					var id = d.replace(/\s+/g, '-');
					$("#clusterSummaries").append("<div class='summary'><a href='#" + id + "'>" + d + "</a><br><b>" + data[d][0]["word"] + "</b> <div id='" + id + "summaryDocCount'></div>" + "</div>");
					numClusters = numClusters + 1;
					// var element = document.getElementById('totalDocCount').outerHTML;
					var row = "<div class='row clusterData' id='" + id +"'>\
									<div class='col-md-3'>\
										<div class='clusterTitle' id='" + id + "Title'>"+ d +"\
										</div>\
										<div class='wordHeader'>Top Words: \
										</div>\
									</div>\
									<div class='col-md-9'>\
										<div class='docHeader'>\
											<div class='docCount'>\
											</div>\
											<div class='verify'>\
		    									<form action='{{ url_for('verified') }}' method='post' class='verifyForm'>\
		    										<input type='checkbox' id ='" + id + "VerifyBox' onclick='markValid(this.id)'> Verify\
		    									</form>\
											</div>\
										</div>\
										<div class='docBody'>\
										</div>\
									</div>\
								</div>";
					// console.log(id);
					// console.log(data[d][0]);
					$(".container").append(row);
					// var chbxId = "'" + id + "Chbx'";
					console.log(data[d][0]['word'])
					var word = "";
					// var sentence = "";
					var sentenceCount = 0;
					var sentenceWeight = "";
					for(var i = 0; i<data[d].length; i++){
						for (var p in data[d][i]) {
							if(p === "word"){
								word += (i+1) + ". <b>" + data[d][i][p] + "</b> ";
							}
							else if(p === "word_weight"){
								word += "(" + data[d][i][p] + ")<br>";
								$('#' + id + ' .col-md-3').append("<div class='topWord'>"+ word +"</div>");
								word = "";
							}
							else if(p === "sentence"){
								var sentence = "\"..." + data[d][i][p] + "\" " + sentenceWeight;
								$('#' + id + ' .docBody').append("<div class='goodDoc' style='display:block;' id='" + id + "sentence" + sentenceCount + "' onclick='markDocument(this.id)'> <input type='checkbox' id ='" + id + "sentence" + sentenceCount +"VerifyBox'>\t"+ sentence +"</div>");
								sentenceCount += 1;
								sentenceWeight = "";
							}
							else if(p === "sent_weight"){
								sentenceWeight = "(" + data[d][i][p] + ")<br>";
							}
							else if(p === "doc_count"){
								$('#' + id + ' .docCount').append("<div> Documents in cluster: "+ data[d][i][p] +"</div>");
								$('#' + id + 'summaryDocCount').append(data[d][i][p] + " docs")
							}
							
						}				
					}
					document.getElementById(id + 'VerifyBox').value = getVerifiedClusterData(id);
				}



			} // endfor
			var screenPercent = 100/numClusters + "%";
			$('.summary').css('width', screenPercent);

			var stopWords = '{{stop_words}}'.replace(/&#39;/g, "").replace(/{/g, "").replace(/}/g, "");
			// stopWords.forEach(function(value) {
			// 	console.log(value);
			// });
			if(stopWords !== 'set()'){
				$('#stopWordsRow').append(stopWords);
			}

			$("#filler").height($("#header").outerHeight());
			$("#backCover").height($("#header").height());
			$("#backCover").width($("#container").outerWidth());


		})
		
	</script>

	<div class="container" id = "pageContainer">
	</div>
</body>

</html>