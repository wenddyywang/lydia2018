<html>
<head>
	<meta charset="utf-8">

	<title>K-means Text Clustering</title>
	<meta name="description" content="text clustering UI">
	<meta name="author" content="wendy">
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.min.js"></script>
	<!--  <meta http-equiv="cache-control" content="no-cache, must-revalidate, post-check=0, pre-check=0" />
	 <meta http-equiv="cache-control" content="max-age=0" />
	 <meta http-equiv="expires" content="0" />
	 <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
	 <meta http-equiv="pragma" content="no-cache" /> -->
	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
	<meta http-equiv="Pragma" content="no-cache" />
	<meta http-equiv="Expires" content="0" />
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.2/css/bootstrap.min.css" integrity="sha384-Smlep5jCw/wG7hdkwQ/Z5nLIefveQRIY9nfy6xoR1uRYBtpZgI6339F5dgvm/e9B" crossorigin="anonymous">
	<script>
		function hasTickedBox(checkBoxID) {
		    var chkbx = document.getElementById( checkBoxID );
		    var titleId = checkBoxID.substring(0, checkBoxID.indexOf('Chbx')) + 'Title';
		    if ( chkbx.checked ) {
		        document.getElementById(titleId).style.color = "#228B22";
		        document.getElementById(checkBoxID).value = "verified";
		    }
		    else{
		    	document.getElementById(titleId).style.color = "#000000";
		    	document.getElementById(checkBoxID).value = "notVerified";
		    }

		}

		function markDocument(sentenceId){
			var element = document.getElementById(sentenceId);
    		element.classList.toggle("goodDoc");
    		element.classList.toggle("badDoc");
    		var clusterId = sentenceId.substring(0, sentenceId.indexOf("sentence"));
    		document.getElementById(clusterId + 'VerifyBtn').value = getVerifiedClusterData(clusterId);
		}

		function getVerifiedClusterData(clusterId){
			var str = "";
			var cluster = document.getElementById(clusterId);
			var rightSide = cluster.getElementsByClassName('col-md-3')[0];
			var clusterTitle = document.getElementById(clusterId + "Title").innerHTML.trim();
			var topWords = rightSide.getElementsByClassName('topWord');
			var docs = cluster.getElementsByClassName('docBody')[0];
			var goodDocs = docs.getElementsByClassName('goodDoc');

			str += clusterTitle + "\n";
			for(var i = 0; i < topWords.length; i++){
				str += topWords[i].textContent.trim() + "\n";
			}

			for(var i=0; i<goodDocs.length; i++)
            {
                str += goodDocs[i].textContent.trim().substring(4, goodDocs[i].textContent.lastIndexOf('\"')) + goodDocs[i].textContent.trim().substring(goodDocs[i].textContent.lastIndexOf('\"') + 1) + "\n";
            }

            return str.replace(/"/g, "'");
		}
	</script>
	<style>
	.badDoc{
		color: rgba(254, 27, 7, 0.7);
		margin-bottom: 20;
	}
	button{
		margin: 10;
		float: right;
	}
	.clusterData{
	    border-bottom: 1px solid black;
	    padding: 10 10;
	}
	#clusterSummaries{
		border-bottom: 1px solid black;
		padding: 10 10;
	}
	.clusterTitle{
	    font-size: 1.5rem;
	    font-weight: bold;
	    margin-bottom: 5;
	}
	.docBody{
		overflow-y: scroll;
		height: 200px;"
	}
	.docCount{
		float: left;
		width: 75%;
	}
	.goodDoc{
		color: black;
	    margin-bottom: 20;
	}
	#header{
		padding-top: 10;
	}
	.goodDoc, .badDoc{
		cursor: pointer;
	}
	.summary{
		float: left;
		text-align: center;
	}
	.summary mark{
		background-color: rgba(37,101,222,0.6) !important;
	}
	#totalDocCount{
		font-size: 1.25rem;
		margin-bottom: 10;
	}
	.wordHeader, .docHeader{
		font-size: 1.25rem;
	    margin-bottom: 10;
	}
	/*
	input[type='checkbox']{
		padding-bottom: : 0.5rem;
	}*/
	</style>
</head>

<body>
	<!-- <script src="coms_cluster_data.js"></script> -->
	<script src="{{url_for('static', filename='coms_cluster_data.js')}}"></script> 
	<script>
		$(document).ready(function(){
			// console.log(data);
    			for(d in data){
    				if(d === "Document count"){
    					var c = '{{ count }}'
    					var row = "<div class='row' id='header'> \
    									<div class='col-md-6'> \
    										<div id='totalDocCount'> \
    											Total Document Count: " + data[d] + "\
    										</div> \
    									</div> \
    									<div class='col-md-6'> \
    										<form action='{{ url_for('verified') }}' method='post' target='_blank'>\
	    										<button name='verifiedBtn' type='submit' value='seeVerified'> \
	    											See Verified Clusters \
	    										</button> \
    										</form>\
    									</div>\
    								</div> \
    								<div class='row'> \
    									<div class='col-md-12'> \
    										<form action='{{ url_for('recluster', counter=count) }}' method='post' id='form' name='stopwordInput'>\
    											Add Stop Word: \
    											<input type='text' name='addStopword'> \
    											Remove Stop Word: \
    											<input type='text' name='removeStopword'> \
    											K: \
    											<input type='text' name='k'> \
    											N Top Words: \
    											<input type='text' name='nTopWords'> \
    											<br> \
    											<button name='reclusterBtn' type='submit' value='recalcDiffSeed'> \
    												Recalculate Clusters with New Seed \
    											</button> \
    											<button name='reclusterBtn' type='submit' value='recalcSameSeed'> \
    												Recalculate Clusters \
    											</button> \
    										</form>\
    										<br> \
    									</div> \
    								</div> \
    								<div class='row'> \
    									<div class='col-md-12' id='clusterSummaries'> \
	    									<div> \
	    										Overview: \
	    									</div> \
    									</div> \
    								</div>";
    					$(".container").append(row);
    					// Append 'summaries' of clusters to header
    					var numClusters = 0;
    					for(d in data){
    						if(d !== "Document count"){
    							var id = d.replace(/\s+/g, '-');
    							$("#clusterSummaries").append("<div class='summary'><a href='#" + id + "'>" + d + "</a><br><b>" + data[d][0]["word"] + "</b> (" + data[d][0]["word_weight"] + ")" + "</div>");
    							numClusters = numClusters + 1;
    						}
    					}
    					var screenPercent = 100/numClusters + "%";
    					$('.summary').css('width', screenPercent);
    				}
    				else{
	    				var id = d.replace(/\s+/g, '-');
						// var element = document.getElementById('totalDocCount').outerHTML;
	    				var row = "<div class='row clusterData' id='" + id +"'>\
	    								<div class='col-md-3'>\
	    									<div class='clusterTitle' id='" + id + "Title'>"+ d +"\
	    									</div>\
	    									<div class='wordHeader'>Top Words: \
	    									</div>\
	    								</div>\
	    								<div class='col-md-9'>\
	    									<div class='docHeader'>\
	    										<div class='docCount'>\
	    										</div>\
	    										<div class='verifyCheckBox'>\
			    									<form action='{{ url_for('verified') }}' method='post' class='verifyForm' target='_blank'>\
				    									<input type='checkbox' name='verifyCheck' id='" + id + "Chbx' value='notVerified' onclick='hasTickedBox(this.id)'> Mark Valid\
				    									<button name='verifyBtn' id ='" + id + "VerifyBtn' type='submit'> \
    														Verify \
    													</button> \
			    									</form>\
	    										</div>\
	    									</div>\
	    									<div class='docBody'>\
	    									</div>\
	    								</div>\
	    							</div>";
						// console.log(id);
						// console.log(data[d][0]);
						$(".container").append(row);
						// var chbxId = "'" + id + "Chbx'";

						var word = "";
						var sentence = "";
						var sentenceCount = 0;
						for(var i = 0; i<data[d].length; i++){
							for (var p in data[d][i]) {
								if(p === "word"){
									word += (i+1) + ". <b>" + data[d][i][p] + "</b> ";
								}
								else if(p === "word_weight"){
									word += "(" + data[d][i][p] + ")<br>";
									$('#' + id + ' .col-md-3').append("<div class='topWord'>"+ word +"</div>");
									word = "";
								}
								else if(p === "sentence"){
									sentence += "\"..." + data[d][i][p] + "\" ";
								}
								else if(p === "sent_weight"){
									sentence += "(" + data[d][i][p] + ")<br>";
									$('#' + id + ' .docBody').append("<div class='goodDoc' id='" + id + "sentence" + sentenceCount + "' onclick='markDocument(this.id)'>"+ sentence +"</div>");
									sentenceCount += 1;
									sentence = "";
								}
								else if(p === "doc_count"){
									$('#' + id + ' .docCount').append("<div> Documents in cluster: "+ data[d][i][p] +"</div>");
								}
								
							}				
						}
    					document.getElementById(id + 'VerifyBtn').value = getVerifiedClusterData(id);
    				}


				}

		})
		
	</script>

	<div class="container" id = "pageContainer">
	</div>
</body>

</html>